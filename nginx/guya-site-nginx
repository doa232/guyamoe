upstream hachi_guyamoe {
    server unix:///home/hachi/guyamoe/nginx/socket/guya.sock; # for a file socket
}

server {
    if ($host = hachirumi.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    listen [::]:80;

    server_name hachirumi.com ;
    return 404; # managed by Certbot
}

server {
    listen 443 ssl; # managed by Certbot
    #listen [::]:443 ssl ipv6only=on; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/hachirumi.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/hachirumi.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    server_name hachirumi.com ;

    # To enable maintenance move this file from homepage/template/homepage/maintenance to the root.
    if (-f /home/hachi/guyamoe/maintenance.html) {
        return 503;
    }
    error_page 503 @maintenance;
    location @maintenance {
        root /home/hachi/guyamoe/ ;
        rewrite ^(.*)$ /maintenance.html break ;
    }

    client_max_body_size 100M;

    location /media {
        expires 365d;
        alias /home/hachi/guyamoe/media;
    }

    location ~ ^/static/(.*) {
        expires 365d;
        gzip on;
        gzip_disable "msie6";

        gzip_comp_level 2;
        gzip_min_length 1100;
        gzip_buffers 16 8k;
        gzip_proxied any;
        gzip_types
            text/plain
            text/css
            text/js
            text/xml
            text/javascript
            application/javascript
            application/json
            application/xml
            application/rss+xml
            image/svg+xml;
        root /home/hachi/guyamoe;
        try_files /static_global/$1 /homepage/static/$1 /reader/static/$1 /static/$1 @process_in_app;
    }

    location / {
        uwsgi_pass hachi_guyamoe;
        include /home/hachi/guyamoe/nginx/uwsgi_params;
    }

    location @process_in_app {
        uwsgi_pass hachi_guyamoe;
        include /home/hachi/guyamoe/nginx/uwsgi_params;
    }
}


